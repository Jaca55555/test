<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta th:include="fragments/head :: top" th:remove="tag">
    <link rel="stylesheet" href="/static/doc/assets/plugins/jquery-ui/css/jquery-ui.min.css">
    <title th:text="#{doc_incoming.reg}">Kiruvchi Xatlar Ro'yxati</title>
    <style>
        #upload-gif{
            position: relative;
            float: left;
            top: 25px;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 85px;
        }
        #percentage {
            display: none;
        }

         .datepicker>.datepicker-days {
             display: block;
         }

    </style>
</head>
<body>
<div class="background"></div>

<!-- [ Pre-loader ] start -->
<div class="loader-bg">
    <div class="loader-track">
        <div class="loader-fill"></div>
    </div>
</div>
<!-- [ Pre-loader ] end -->

<object th:include="fragments/nav_menu :: menu" th:remove="tag" ></object>

<object th:include="fragments/navbar :: navbar" th:remove="tag" ></object>

<!--/*@thymesVar id="document" type="uz.maroqand.ecology.docmanagement.entity.Document"*/-->
<div class="pcoded-main-container">
    <div class="col-xl-12 col-md-12">
        <div class="card parent-card">
            <div class="card-header flex-space-between">
                <h5 class="mb-0" th:if="${document.id==null}" th:text="#{doc_incoming.reg}">Кирувчи хатни рўйхатга олиш</h5>
                <h5 class="mb-0" th:if="${document.id!=null}" th:text="#{doc_incoming.edit}">Кирувчи хатни тахрирлаш - <span th:text="${document.registrationNumber}">IN-123456-MRQ</span></h5>
                <!--<div>
                    <div>
                        <button class="btn-icon"><i class="fas fs20 fa-save color-gray"></i></button>
                        <button class="btn-icon"><i class="fas fs20 fa-print color-gray"></i></button>
                    </div>
                </div>-->
            </div>
            <form action="" th:object="${document}" th:method="post" class="card-block" data-parsley-validate="" id="doc_task">
                <div th:if="${document.id != null}">
                    <input type="hidden" th:field="*{id}" />
                    <input type="hidden" name="docSubId" th:value="${documentSub.id}"/>
                    <input type="hidden" th:field="${documentSub.documentId}" th:value="${documentSub.documentId}"/>
                </div>
                <div class="row">
                    <div class="col-sm-6 col-lg-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.journal}">Кирувчи хатларни руйхатга олиш журнали</label>
                        <select class="singleSelect col-sm-12 select2-hidden-accessible" th:field="*{journalId}" required="required" data-parsley-errors-container="#journalIdError">
                            <option value=""></option>
                            <option th:each="journal: ${journalList}" th:value="${journal.id}" th:text="${journal.name}"></option>
                        </select>
                        <div class="row"> <div class="col-md-6 p0" id="journalIdError"></div> </div>
                    </div>
                    <div class="col-sm-6 col-lg-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.documentView}" th:for="${#ids.seq('documentType')}">Кирувчи хатларни тури</label>
                        <select class="singleSelect col-sm-12 select2-hidden-accessible" th:field="*{documentViewId}" required="required" data-parsley-errors-container="#documentViewError">
                            <option value=""></option>
                            <option th:each="documentView: ${documentViewList}" th:value="${documentView.id}" th:text="${documentView.name}"></option>
                        </select>
                        <div class="row"> <div class="col-md-6 p0" id="documentViewError"></div> </div>
                    </div>
                    <div class="col-sm-6 col-lg-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.reg_doc_number}" th:for="${#ids.next('registration_number')}">Кирувчи хатларни руйхатга олиш раками</label>
                        <div class="col-sm-12 p0">
                            <input type="text" class="form-control" th:field="*{docRegNumber}" required="required">
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.reg_doc_date}">Хат рўйхатга олинган сана</label>
                        <div class="col-sm-12 p0">
                            <input  autocomplete="off" class="form-control datepicker date" id="dateBegin" th:placeholder="#{doc_income.reg_date}" data-dtp="dtp_lq7TC" name="docRegDateStr" required="required"  th:value="${document.docRegDate!=null? #dates.format(document.docRegDate,'dd.MM.yyyy'):''}">
                            <i class="gray-arrow mdi mdi-calendar color-gray"></i>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.communication_tool}"></label>
                        <select class="singleSelect col-sm-12 select2-hidden-accessible" th:field="${documentSub.communicationToolId}">
                            <option value=""></option>
                            <option th:each="communicationTool: ${communicationToolList}" th:value="${communicationTool.id}" th:text="${communicationTool.name}"></option>
                        </select>
                    </div>
                    <div class="col-sm-6 col-lg-6 form-group">
                        <label class="control-label" for="documentOrganizationId" th:text="#{doc_incoming.organization}"></label>
                        <select class="form-control" id="documentOrganizationId" name="documentOrganizationId" required="required" data-parsley-errors-container="#documentOrganizationIdError">
                            <option th:if="${documentOrdanization!=null}" th:value="${documentOrdanization.id}" th:text="${documentOrdanization.name}" selected="selected"></option>
                            <option value="" th:text="#{sys_select}"></option>
                        </select>
                        <div class="row"> <div class="col-md-6 p0" id="documentOrganizationIdError"></div> </div>
                    </div>
                </div>

                <div class="col-sm-12 form-group">
                    <label class="control-label" th:text="#{doc_incoming.description}"></label>
                    <select class="singleSelect col-sm-12 select2-hidden-accessible" th:field="*{contentId}" id="description_content">
                        <option value=""></option>
                        <option th:each="description : ${descriptionList}" th:value="${description.id}" th:text="${description.content}"></option>
                    </select>
                </div>
                <div class="col-sm-12 form-group new-desc">
                    <textarea class="form-control" rows="4" name="content" maxlength="500" th:text="*{content}" id="description_textarea" required="required"></textarea>
                </div>

                <div class="row">
                    <div class="form-group col-sm-12 col-md-6">
                        <label class="control-label" th:text="#{doc_incoming.reg_additional_doc}"> </label>
                        <select class="singleSelect select2-hidden-accessible" id="additionalDocumentId" name="additionalDocumentId">
                            <option value=""></option>
                            <option th:if="${additionalDocument!=null}" th:value="${additionalDocument.id}"  th:text="${additionalDocumentText}" selected="selected"></option>
                        </select>
                    </div>
                </div>

                <hr class="m30-vertical">
                <h5 class="mb-0 card-header no-border" th:text="#{doc_incoming.reg_files}" style="padding: 5px 20px;">Кирувчи хат ва унинг иловаларининг электрон шакли</h5>
                <div class="row p20" id="file-container">

                    <div class="file-block flex-center file-button" id="addFileBlock" onclick="clickPlus()">
                        <div  class="text-center file-icon-container align-self-center color-gray">
                            <span class="fas fa-plus" id="addFileButton"></span>
                            <!--                            <input type="file" class="d-none" id="addFile" name="files" multiple required>-->
                            <span id="percentage" style="font-size: 40px"><span id="percentage-num"></span>%</span>
                            <img src="/static/doc/images/uploading.gif" alt="" id="upload-gif" style="display: none;">
                        </div>
                    </div>

                </div>
                <div id="file_ids" class="d-none">
                    <input type="text" name="file_ids" value="">
                </div>
                <div id="addFileDiv">
                    <input type="file" class="d-none" id="addFile2" name="files">
                </div>
                <div class="border-warning m20 p20">
                    <div class="checkbox checkbox-fill d-inline checkbox-danger">
                        <input type="checkbox" name="insidePurpose" id="checkbox-fill-1" th:checked="${document!=null && document.insidePurpose!=null && document.insidePurpose}">
                        <label for="checkbox-fill-1" class="cr text-danger" ><span th:text="#{doc_incoming.reg_inside_purpose}">Checked</span></label>
                    </div>
                    <div class="m20-vertical">
                        <span th:text="#{sys_attention}">Диккат:</span>
                        <br>
                        <span th:text="#{doc_incoming.reg_inside_purpose_attention}">Хизмат доирасида фойдаланиш учун" белгисига эга бўлган хужжатлар фақат рахбарлар ёки девонхона ходимлари томонидан белгиланган ходимларга кўринади.</span>
                    </div>
                </div>

                <hr class="m30-vertical">
                <div class="row">
                    <div class="col-sm-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.reg_manager}">Кирувчи хатни қабул қилиш учун маъсул рахбар</label>
                        <select class="singleSelect col-sm-12 select2-hidden-accessible" th:field="*{managerId}" required="required" data-parsley-errors-container="#managerIdViewError">
                            <option value=""></option>
                            <option th:each="manager: ${managerUserList}" th:value="${manager.id}" th:text="${manager.getFullName()}" th:selected="${document.managerId!=null && manager.id==document.managerId}"></option>
                        </select>
                        <div class="row"> <div class="col-md-6 p-0" id="managerIdViewError"></div> </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-sm-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.reg_execute_form}">Хатнинг ижроси шакли</label> <br>
                        <div class="custom-control custom-radio custom-control-inline" th:each="executeForm : ${executeForms}">
                            <input type="radio" name="executeFormId" onclick="displayRadioValue()" th:id="'executeForm'+${executeForm.id}" th:value="${executeForm.id}" class="custom-control-input" th:checked="${document.executeForm!=null && executeForm.id==document.executeForm.id}">
                            <label class="custom-control-label" th:for="'executeForm'+${executeForm.id}" th:text="#{${executeForm.name}}"></label>
                        </div>

                        <div ID="pnlImgSlider1" class="custom-control custom-checkbox">
                            <input type="checkbox" name="specialControl" th:checked="${document!=null}" class="custom-control-input" id="defaultIndeterminate2" checked>
                            <label class="custom-control-label" for="defaultIndeterminate2" th:text="#{doc.special_controll}">Default indeterminate</label>
                        </div>
                    </div>


                </div>
                <div class="row">
                    <div class="col-sm-6 form-group">
                        <label class="control-label" th:text="#{doc_incoming.reg_control_form}">Назорат карточкасининг шакли</label> <br>
                        <div class="custom-control custom-radio custom-control-inline" th:each="controlForm: ${controlForms}">
                            <input type="radio" th:value="${controlForm.id}" name="controlFormId" th:id="'controlForm'+${controlForm.id}" class="custom-control-input" th:checked="${document.controlForm!=null && controlForm.id==document.controlForm.id}">
                            <label class="custom-control-label" th:for="'controlForm'+${controlForm.id}" th:text="#{${controlForm.name}}"></label>
                        </div>
                    </div>
                </div>

                <div id="tasks">
                    <div class="row flex-space-between" id="task_1">
                        <div class="col-xl-12 col-sm-12 pl-0 pl-15-mobile">
                            <div class=" parent-card">
                                <div class="card-header flex-space-between align-center" style="height:65px;">
                                    <h5><span th:text="#{doc_incoming.task_number}"></span>&nbsp;№ 1</h5>
                                    <div class="flex-space-between p0 align-center column-2">
                                        <button type="button" class="btn-icon" onclick="deleteTask(1)">
                                            <i class="feather icon-trash-2 fs20 color-gray"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-block pt-0">
                                    <div class="row">
                                        <div class="executor col-6 m10-vertical mt-0">
                                            <div class="form-group">
                                                <label class="control-label" th:text="#{doc_incoming.doc_task_and_content}"></label>
                                                <select class="singleSelect col-sm-12 select2-hidden-accessible" id="description_content_task_1" onchange="description_content_task(1)">
                                                    <option value=""></option>
                                                    <option th:each="taskContent : ${taskContentList}" th:value="${taskContent.id}" th:text="${taskContent.getNameTranslation(#locale)}"></option>
<!--                                                    <option th:each="description : ${descriptionList}" th:value="${description.content}" th:text="${description.content}"></option>-->
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <textarea class="form-control" rows="4" name="descriptionTextareaTask_1" id="description_textarea_task_1" required="required" minlength="5"></textarea>
                                            </div>
                                            <div class="form-group" >
                                                <label class="control-label" th:text="#{doc_incoming.task_deadline}">
                                                    <span th:text="#{sys.doc_executeDate}">Ижро муддати</span>
                                                </label>
                                                <div class="col-sm-12 p0">
                                                    <input autocomplete="off" class="form-control datepicker date" id="dateBegin_task_1"  data-dtp="dtp_lq7TC" name="taskDocRegDateStr_1" required="required" />
                                                    <i class="gray-arrow mdi mdi-calendar color-gray"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="taskNumber_1"/>
                                        <div class="executor col-6 m10-vertical">
                                            <div class="form-group">
                                                <label class="control-label" th:text="#{doc_incoming.task_sub_receivers}"></label>
                                                <div class="table-responsive">
                                                    <table id="data-table_1" class="table table-hover dataTable" style="width: 100%">
                                                        <tbody>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div id="addUsers_1">
                                                    <select class="singleSelect col-sm-12 select2-hidden-accessible" id="userId_1" onchange="changeUserPerformer(1)">
                                                        <option value="">Шаблондан танланг ёки қуйида топшириқ матнини киритинг</option>
                                                        <option th:each="user: ${userList}" th:value="${user.id}" th:text="${user.getFullName()}" ></option>
                                                    </select>
                                                </div>

                                            </div>
                                        </div>
                                        <input type="hidden" id="typePerformerIsTaskId_1" value=""/>
                                        <input type="hidden" id="typeControlIsTaskId_1" value=""/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--                Task add end-->
                <div class="card-footer">
                    <div class="flex-center w100 row-wrap">
                        <button type="button" onclick="addTaskForm()"  class="btn btn-primary m10-vertical m20-horizontal pr-5 pl-5" >
                            <i class="fas fa-plus-square"></i>
                            <span th:text="#{doc_incoming.newTask}"></span>
                        </button>
                        <button type="button" onclick="addTaskSubmit()" class="btn btn-success m10-vertical m20-horizontal pr-5 pl-5" th:text="#{sys_save}">Рўйхатга олиш</button>
                    </div>
                </div>
                <input type="hidden" id="global_csrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </form>
        </div>
    </div>
</div>

<object th:include="fragments/footer :: footer" th:remove="tag"></object>

<script type="text/javascript" src="/static/doc/assets/plugins/jquery-ui/js/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-migrate/3.0.1/jquery-migrate.min.js"></script>
<script type="text/javascript" src="/static/parsley/parsley.min.js"></script>
<script th:src="@{'/static/parsley/i18n/' + __${#locale}__ + '.js'}"></script>
<script type="text/javascript" src="/static/doc/assets/plugins/bootstrap-datetimepicker/js/bootstrap-datepicker.min.js"></script>
<script src="/static/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
<script src="/static/doc/js/jquery.inputmask.bundle.min.js"></script>
<script type="text/javascript" th:inline="javascript">
    let sys_select = [[#{sys_select}]];

    function clickPlus() {
        $('#addFile2').click();
    }
    $(document).ready(function ()
    {
        hearInputClickFunction();
        $('.singleSelect').select2({
            placeholder: sys_select,
            allowClear: true
        });
        $('#phoneNumber').inputmask("+999(99) 999-99-99");
        var files = [[${document.contentFiles}]];
        if (files!=null && files.length>0){
            $.each(files,function (index,val) {
                $('#fileIds').append("<option selected='selected' value='"+val.id+"'>"+val.description+"</option>");
                var fileName=$('#fileName_'+val.id).text();
                var subStringFileName = fileNameSubString(fileName);
                $('#fileName_'+val.id).text(subStringFileName);
            })
        }

        $('textarea.max-textarea').maxlength({
            alwaysShow: true
        });

        $('#description option[value=""]').after('<option value="new">Yangi qisqacha ma\'lumot</option>');

        $('#addFileButton').on('click', function () {
            $('#addFile').click();
        });
        $('#addFile').on('click', function (e) {
            e.stopImmediatePropagation();
        }).on('change', function () {
            if (this.files[0].size > 10000000) {
                swal("Файл не должен занимать больше 10 мб.",'', "warning");
                return false;
            }
            if(this.files[0].size === 0){
                swal("Файл не должен быть пустым", "", "warning");
                return false;
            }
            let csrf = $("form input[name='_csrf']").val();
            let files = $(this)[0].files[0];
            let fd = new FormData();
            fd.append("file", files);
            fd.append("_csrf", csrf);
            $.ajax({
                url: [[${T(uz.maroqand.ecology.docmanagement.constant.DocUrls).IncomeMailFileUpload}]],
                type: 'post',
                data: fd,
                processData: false,
                contentType: false,
                enctype: 'multipart/form-data',
                success: detectExtensionAndDisplay,
                beforeSend: function () {
                    $('#plus-icon').hide();
                    $('#upload-gif').show();
                    $('#percentage').show();
                },
                complete: function () {
                    $('#upload-gif').hide();
                    $('#percentage').hide();
                    $('#plus-icon').show();
                },
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress",
                        uploadProgressHandler,
                        false
                    );
                    return xhr;
                }
            })
        });

        $('#description').on('change', function () {
            if ($(this).val() === 'new') {
                $('.new-desc').removeClass('d-none');
            } else {
                $('.new-desc').addClass('d-none');
            }
        });


        $('form').on('submit', function (e) {
            $('#addFile').attr('disabled', 'disabled');
            if ($('#description').val() === 'new') $('#description').attr('disabled', 'disabled');
            else $('#newDescription').attr('disabled', 'disabled');
        });

        $('#documentOrganizationId').select2({
            tags: true,
            ajax: {
                url: [[${T(uz.maroqand.ecology.docmanagement.constant.DocUrls).RegistrationOrganization}]],
                type: "POST",
                data: function (params) {
                    return { search: params.term, page: params.page || 1, _csrf: $('#global_csrf').val() };
                }, cache: true
            }
        });
        $('#additionalDocumentId').select2({
            ajax: {
                url: [[${T(uz.maroqand.ecology.docmanagement.constant.DocUrls).RegistrationAdditionalDocument}]],
                type: "POST",
                data: function (params) {
                    return { search: params.term, page: params.page || 1, _csrf: $('#global_csrf').val() };
                },
                success:function(data){
                    console.log(data);
                },
                escapeMarkup: function(params) {
                    return params;
                },
                cache: true
            }
        });

        $('input[name=executeFormId]:first, input[name=controlFormId]:first').trigger('click');
    });

    $('#description_content').on('change',function () {
        var text=this.options[this.selectedIndex].text;
        var dec = $('#description_textarea').val();
        $('#description_textarea').val(dec + text);
    });

    function displayRadioValue() {
        var ele = document.getElementsByName('executeFormId');

        for(i = 0; i < ele.length; i++) {
            if(ele[i].checked)
                return  ele[i].value;
        }

    }

    function uploadProgressHandler(event)
    {
        var percent = (event.loaded / event.total) * 100;
        var progress = Math.round(percent);
        $('#percentage-num').html(progress);
    }

    let dropArea = document.querySelector('.file-button');

    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false)
    })
    function deleteFunc(id){
        fetch(`/doc/registration/incoming/file/delete?id=${id}`);
        $('#addFile2').remove();
        $(`#file_block_${id}`).remove();
        $(`#input_file_id_${id}`).remove();
        $('#addFileDiv').append(`
             <input type="file" class="d-none" id="addFile2" name="files">
        `);
        hearInputClickFunction();
    }
    function hearInputClickFunction(){
        $('#addFile2').on('change', function () {
            if (this.files[0].size > 10000000) {
                swal("Файл не должен занимать больше 10 мб.",'', "warning");
                return false;
            }
            if(this.files[0].size === 0){
                swal("Файл не должен быть пустым", "", "warning");
                return false;
            }
            let csrf = $("form input[name='_csrf']").val();
            let files = document.querySelector('#addFile2').files[0];
            let fd = new FormData();
            fd.append("file", files);
            fd.append("_csrf", csrf);
            $.ajax({
                url: "/doc/file_upload",
                type: 'post',
                data: fd,
                processData: false,
                contentType: false,
                enctype: 'multipart/form-data',
                success: detectExtensionAndDisplay,
                beforeSend: function () {
                    $('#addFileButton').hide();
                    $('#upload-gif').show();
                    $('#percentage').show();
                },
                complete: function () {
                    $('#upload-gif').hide();
                    $('#percentage').hide();
                    $('#addFileButton').show();
                },
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress",
                        uploadProgressHandler,
                        false
                    );
                    return xhr;
                }
            })
        });
    }
    function preventDefaults (e) {
        e.preventDefault()
        e.stopPropagation()
    }

    dropArea.addEventListener('drop', handleDrop, false)

    function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files
        console.log(files);
        let csrf = $("form input[name='_csrf']").val();
        let fd = new FormData();
        fd.append("file", files[0]);
        fd.append("_csrf", csrf);
        $.ajax({
            url: "/doc/file_upload",
            type: 'post',
            data: fd,
            processData: false,
            contentType: false,
            enctype: 'multipart/form-data',
            success: detectExtensionAndDisplay,
            beforeSend: function () {
                $('#addFileButton').hide();
                $('#upload-gif').show();
                $('#percentage').show();
            },
            complete: function () {
                $('#upload-gif').hide();
                $('#percentage').hide();
                $('#addFileButton').show();
            },
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress",
                    uploadProgressHandler,
                    false
                );

                return xhr;
            }
        })



        // handleFiles(files)
    }

    function detectExtensionAndDisplay(data){
        let extension = data.data.extension;
        let fileName = data.data.name;
        let color;
        switch (extension) {
            case 'jpg': case 'png': case 'jpeg':
                extension = '-image';
                color = 'color-yellow';
                break;
            case 'pdf':
                extension = '-pdf';
                color = 'color-red';
                break;
            case 'xlsx':case 'xls':
                extension = '-excel';
                color = 'color-green';
                break;
            case 'doc':
            case 'docx':
                extension = '-word';
                color = 'color-blue';
                break;
            case 'pptx':
                extension = '-powerpoint';
                color = 'color-red';
                break;
            case 'zip': case '7z': case 'rar':
                extension = '-archive';
                color = 'color-purple';
                break;
            default:
                extension = '';
                color = 'color-gray';
        }
        function downloadFileFunction(id) {
            window.open(`/doc/incoming/file/download?id=${id}`);
        }
        $('#fileIds').append(`<option selected="selected" value="${data.data.id}">`+fileNameSubString(fileName)+`</option>`);
        $('#file_ids').append(
        `<input type="text" name="file_ids" id="input_file_id_${data.data.id}" value="${data.data.id}">`
    );
        $('#file-container').append(
            `<div class="file-block" id="file_block_${data.data.id}">
                        <div class="text-right"><span class='fas fa-trash-alt' onclick="deleteFunc(${data.data.id})"></span></div>
                        <div class="text-center file-icon-container ${color}" onclick="downloadFileFunction(${data.data.id})"><span class="fa fa-file${extension}"></span>
                        </div>
                        <div class="text-center">
                            <span>` + fileNameSubString(fileName) + `</span>
                        </div>
                    </div>`
        );
    }
</script>
<!--task-->
<script th:inline="javascript">
    let taskNumber=1;
    let task_sub_type_performer = [[#{task_sub_type.performer}]];
    let task_sub_type_performer_partner = [[#{task_sub_type.performer_partner}]];
    let task_sub_type_control = [[#{task_sub_type.control}]];
    let task_sub_type_info = [[#{task_sub_type.info}]];
    let tasksubtype = 'performance';

    $(document).ready(function () {
        docFileName([[${document.contentFiles}]]);
    });

    function description_content_task(id){
        let text=$('#description_content_task_'+id+" option:selected").text();
        $('#description_textarea_task_'+id).val(text);
    }

    function addTaskSubmit() {
        if (isSubmit()){
            console.log("submit");
            $('#doc_task').submit();
        }
    }
    function isSubmit() {
        let submitFor=true;
        let allTaskCount=0;
        for (i=1;i<=taskNumber; i++) {
            if ($('#data-table_'+i).html()!==undefined){
                if ($('#data-table_'+i+' tr').length==0){
                    $('#addUsers_'+i).css('border','1px solid red');
                    submitFor=false;
                }
            }else{
                allTaskCount++;
            }
        };
        if (allTaskCount==taskNumber || !submitFor) return false;
        return submitFor;
    }

    var url = [[${T(uz.maroqand.ecology.docmanagement.constant.DocUrls).IncomingRegistrationUserName}]];
    function changeUserPerformer(id){
        console.log("changeUserPerformer id=" + id);
        $('#dateBegin_task_'+id).parsley().validate();
        $('#description_textarea_task_'+id).parsley().validate();
        let userId = $('#userId_'+id).val();
        if ( $('#dateBegin_task_'+id).parsley().isValid() && userId!="" && userId!=null){
            let dateDue=$('#dateBegin_task_'+id).val();
            $.ajax({
                url: url,
                data: {
                    id: userId,
                    _csrf: $('#global_csrf').val()
                },
                type: 'post',
                dataType: 'json',
                cache: true,
                success: function (response) {
                    if (response.status==1){
                        let userId=response.userId;
                        let userFullName=response.userFullName;
                        let position=response.position;
                        let html='';
                        if ($('#performerIsTaskId_'+id+'userId_'+userId).val()===undefined){
                            html='<tr id="tr_IsTaskId_'+id+'userId_'+userId+'">' +
                                '   <td style="width: 30%">\n' +
                                '       <div class="flex-space-between p0">\n' +
                                '           <div>\n' +
                                '               <div class="inline-block">\n' +
                                '                   <i class="fas fa-user-circle fs40 color-gray"></i>\n' +
                                '               </div>\n' +
                                '               <div class="inline-block m10-horizontal">\n' +
                                '                   <span class="color-green bold">'+userFullName+'</span>\n' +
                                '                   <br>\n' +
                                '                   <span>'+position+'</span>\n' +
                                '               </div> <input type="hidden" name="user_id'+userId+'" value="'+userId+'"/>\n' +
                                '           </div>\n' +
                                '       </div>\n' +
                                '   </td>';

                            if(displayRadioValue()!=1)
                            {    if ($('#typePerformerIsTaskId_'+id).val()==''){
                                html+='<td style="width: 30%">\n' +
                                    '       <div class="btn-group mb-2 mr-2" id="status_div_id_'+id+'userId_'+userId+'">\n' +
                                    '           <button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_'+userId+'">\n' +
                                    '               <i class="fas fa-cog" style="margin-right: 1em"></i>\n' + task_sub_type_performer +
                                    '           </button>\n' +
                                    '           <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                    '               <span class="sr-only"></span>\n' +
                                    '           </button>\n' +
                                    '           <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                                    '               <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',1)">'+task_sub_type_performer_partner+'</button>\n' +
                                    '               <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',2)">'+task_sub_type_control+'</button>\n' +
                                    '               <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',3)">'+task_sub_type_info+'</button>\n' +
                                    '           </div>\n' +
                                    '           <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="0"/>\n' +
                                    '       </div>\n' +
                                    '   </td>';
                                $('#typePerformerIsTaskId_'+id).val(userId);
                            } else{
                                html+='<td style="width: 30%">\n' +
                                    '       <div class="btn-group mb-2 mr-2" id="status_div_id_'+id+'userId_'+userId+'">\n' +
                                    '           <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                                    '               <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',3)">'+task_sub_type_info+'</button>\n' +
                                    '           </div>\n' +
                                    '           <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="0"/>\n' +
                                    '       </div>\n' +
                                    '   </td>';
                            }}
                            else{
                                if ($('#typePerformerIsTaskId_'+id).val()==''){
                                    html+='<td style="width: 30%">\n' +
                                        '       <div class="btn-group mb-2 mr-2" id="status_div_id_'+id+'userId_'+userId+'">\n' +
                                        '           <button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_'+userId+'">\n' +
                                        '               <i class="fas fa-cog" style="margin-right: 1em"></i>\n' + task_sub_type_info +
                                        '           </button>\n' +
                                        '           <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                        '               <span class="sr-only"></span>\n' +
                                        '           </button>\n' +
                                        '           <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="0"/>\n' +
                                        '       </div>\n' +
                                        '   </td>';
                                    $('#typePerformerIsTaskId_'+id).val(userId);
                                } else{
                                    html+='<td style="width: 30%">\n' +
                                        '       <div class="btn-group mb-2 mr-2" id="status_div_id_'+id+'userId_'+userId+'">\n' +
                                        '           <button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_'+userId+'">\n' +
                                        '               <i class="fas fa-exclamation-circle" style="margin-right: 1em"></i>\n' + task_sub_type_info +
                                        '           </button>\n' +
                                        '           <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +

                                        '           </button>\n' +

                                        '           <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="3"/>\n' +
                                        '       </div>\n' +
                                        '   </td>';
                                }
                            }
                            html+='   <td style="width: 35%">\n' +
                                '       <div class="col-md-12 mb-3">\n' +
                                '           <div class="input-group">\n' +
                                '               <div class="input-group-prepend">\n' +
                                '                   <span class="input-group-text p-1" id="validationTooltipUsernamePrepend">\n' +
                                '                       <i class="feather icon-clock fs20"></i>\n' +
                                '                   </span>\n' +
                                '               </div>\n' +
                                '               <input autocomplete="off" class="form-control datepicker date" data-dtp="dtp_lq7TC" id="dueDateStr_'+userId+'" name="dueDateStr_'+userId+'" required="required" value="'+dateDue+'"/>\n' +
                                '           </div>\n' +
                                '       </div>\n' +
                                '   </td>\n' +
                                '   <td style="width: 5%">\n' +
                                '       <button type="button" class="btn-icon"><i class="fas fs20 fa-trash-alt color-gray" onclick="deleteSelectedUser('+id+','+userId+')"> </i></button>\n' +
                                '   </td>\n' +
                                '</tr>';
                            $('#data-table_'+id+' tbody').append(html);
                            $('.date').datepicker({
                                format: "dd.mm.yyyy",
                                todayHighlight: true,
                                autoclose: true
                            });
                            $('#userId_'+id).val('').change();
                        }
                        $('#addUsers_'+id).css('border','0px');
                    }
                },
                error: function () {
                }
            });
        }else{
            console.log("000")
        }
    }

    function selectType(id,userId,typeId) {
        let performer = $('#performerIsTaskId_'+id+'userId_'+userId).val();
        let typeControl = $('#typeControlIsTaskId_'+id).val();
        let typePerformer = $('#typePerformerIsTaskId_'+id).val();
        if (performer!==undefined){
            if (typeId==0){
                //performer qilmoqchi
                if (typePerformer==''){
                    if (performer==2){ $('#typeControlIsTaskId_'+id).val('');}
                    $('#typePerformerIsTaskId_'+id).val(userId);
                    setType(id,userId,typeId);
                }
            }else
                //control
            if(typeId==2){
                if (typeControl==''){
                    if (performer==0){  $('#typePerformerIsTaskId_'+id).val('');}
                    $('#typeControlIsTaskId_'+id).val(userId);
                    setType(id,userId,typeId);

                }
            }else{
                if (performer==0) { $('#typePerformerIsTaskId_'+id).val('');}
                if (performer==2){ $('#typeControlIsTaskId_'+id).val('');}
                setType(id,userId,typeId);
            }
        }
    }

    function deleteSelectedUser(id,userId) {
        let performer = $('#performerIsTaskId_'+id+'userId_'+userId).val();
        let typePerformerIsTaskId = $('#typePerformerIsTaskId_'+id).val();
        let typeControlIsTaskId = $('#typeControlIsTaskId_'+id).val();
        if (performer!==undefined){
            $('#tr_IsTaskId_'+id+'userId_'+userId).remove();
            if ($('#typePerformerIsTaskId_'+id).val()==id){
                $('#typePerformerIsTaskId_'+id).val('');
            }
            if ($('#typeControlIsTaskId_'+id).val()==id){
                $('#typeControlIsTaskId_'+id).val('');
            }
        }
    }

    function setType(id,userId,typeId){
        let html = '';
        if (typeId===0){

            html = '<button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_id_'+id+'_userId_'+userId+'">\n' +
                '       <i class="fas fa-cog" style="margin-right: 1em"></i>' + task_sub_type_performer +
                '   </button>\n' +
                '   <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                '       <span class="sr-only"></span>\n' +
                '   </button>\n' +
                '   <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',1)">'+task_sub_type_performer_partner+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',2)">'+task_sub_type_control+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',3)">'+task_sub_type_info+'</button>\n' +
                '   </div>\n' +
                '   <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="0"/>';

        }else if(typeId===1){

            html = '<button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_id_'+id+'_userId_'+userId+'">\n' +
                '       <i class="fas fa-cogs" style="margin-right: 1em"></i>' + task_sub_type_performer_partner +
                '   </button>\n' +
                '   <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                '       <span class="sr-only"></span>\n' +
                '   </button>\n' +
                '   <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',0)">'+task_sub_type_performer+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',2)">'+task_sub_type_control+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',3)">'+task_sub_type_info+'</button>\n' +

                '   </div>\n' +
                '   <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="1"/>';

        }else if(typeId===2){

            html = '<button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_id_'+id+'_userId_'+userId+'">\n' +
                '       <i class="fas fa-check-circle" style="margin-right: 1em"></i>' + task_sub_type_control +
                '   </button>\n' +
                '   <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                '       <span class="sr-only"></span>\n' +
                '   </button>\n' +
                '   <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',1)">'+task_sub_type_performer_partner+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',0)">'+task_sub_type_performer+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',3)">'+task_sub_type_info+'</button>\n' +
                '   </div>\n' +
                '   <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="2"/>';

        }else{
            html = '<button type="button" class="btn btn-outline-primary left-radius table-modal-button" id="status_button_id_'+id+'_userId_'+userId+'">\n' +
                '       <i class="fas fa-exclamation-circle" style="margin-right: 1em"></i>' + task_sub_type_info +
                '   </button>\n' +
                '   <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split right-radius table-modal-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                '       <span class="sr-only"></span>\n' +
                '   </button>\n' +
                '   <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(109px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',1)">'+task_sub_type_performer_partner+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',2)">'+task_sub_type_control+'</button>\n' +
                '       <button type="button" class="dropdown-item" onclick="selectType('+id+','+userId+',0)">'+task_sub_type_performer+'</button>\n' +

                '   </div>\n' +
                '   <input type="hidden" name="performer_'+userId+'" id="performerIsTaskId_'+id+'userId_'+userId+'" value="3"/>';

        }
        $('#status_div_id_'+id+'userId_'+userId).html(html);
    }

    function addTaskForm() {
        taskNumber=taskNumber+1;
        console.log("taskNumber" + taskNumber);
        let html='';
        let description_content = '';
        let userListOption = '';
        $.each([[${taskContentList}]],function (item, value) {
            description_content+=`<option  value="`+value.id+`" >`+value.content+`</option>`;
        });

        $.each([[${userList}]],function (item, value) {
            userListOption+=`<option  value="`+value.id+`" >`+value.fullName+`</option>`;
        });
        html=`<div class="row flex-space-between" id="task_`+taskNumber+`">
                        <div class="col-xl-12 col-sm-12 pl-0 pl-15-mobile">
                            <div class=" parent-card">
                                <div class="card-header flex-space-between align-center" style="height:65px;">
                                    <h5><span>`+[[#{doc_incoming.task_number}]]+`</span>&nbsp;№ `+taskNumber+`</h5>
                                    <div class="flex-space-between p0 align-center column-2">
                                        <button type="button" class="btn-icon" onclick="deleteTask(`+taskNumber+`)">
                                            <i class="feather icon-trash-2 fs20 color-gray"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-block pt-0">
                                    <div class="row">
                                        <div class="executor col-6 m10-vertical mt-0">
                                            <div class="form-group">
                                                <label class="control-label" >`+[[#{doc_incoming.doc_task_and_content}]]+`</label>
                                                <select class="singleSelect col-sm-12 select2-hidden-accessible" id="description_content_task_`+taskNumber+`" onchange="description_content_task(taskNumber)">
                                                    <option value=""></option>
                                                    `+description_content+`
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <textarea class="form-control" rows="4"  name="descriptionTextareaTask_`+taskNumber+`" id="description_textarea_task_`+taskNumber+`" required="required" minlength="5"></textarea>
                                            </div>
                                            <div class="form-group" >
                                                <label class="control-label" >
                                                    <span>`+[[#{doc_incoming.task_deadline}]]+`</span>
                                                </label>
                                                <div class="col-sm-12 p0">
                                                    <input autocomplete="off" class="form-control datepicker date" id="dateBegin_task_`+taskNumber+`"  data-dtp="dtp_lq7TC" name="taskDocRegDateStr_`+taskNumber+`" required="required" />
                                                    <i class="gray-arrow mdi mdi-calendar color-gray"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="taskNumber_`+taskNumber+`"/>
                                        <div class="executor col-6 m10-vertical">
                                            <div class="form-group">
                                                <label class="control-label" >`+[[#{doc_incoming.task_sub_receivers}]]+`</label>
                                                <div class="table-responsive">
                                                    <table id="data-table_`+taskNumber+`" class="table table-hover dataTable" style="width: 100%">
                                                        <tbody>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div id="addUsers_`+taskNumber+`">
                                                    <select class="singleSelect col-sm-12 select2-hidden-accessible" id="userId_`+taskNumber+`" onchange="changeUserPerformer(taskNumber)">
                                                        <option value="">Шаблондан танланг ёки қуйида топшириқ матнини киритинг</option>
                                                        `+userListOption+`
                                                    </select>
                                                </div>

                                            </div>
                                        </div>
                                        <input type="hidden" id="typePerformerIsTaskId_`+taskNumber+`" value=""/>
                                        <input type="hidden" id="typeControlIsTaskId_`+taskNumber+`" value=""/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        $('#tasks').append(html);
        $('.singleSelect').select2({
            placeholder: sys_select,
            allowClear: true
        });
        $('.date').datepicker({
            format: "dd.mm.yyyy",
            todayHighlight: true,
            autoclose: true
        });
    }
    $(function(){
        $('input:radio').change(function(){
            if($(this).val() ==0) {
                $("#pnlImgSlider1").show();
            }
            else {
                $("#pnlImgSlider1").hide();
            }
        });
    });
    function deleteTask(id) {
        $('#task_'+id).remove();
    }
    $('input[type=checkbox]').removeAttr('checked');
</script>

</body>
</html>
