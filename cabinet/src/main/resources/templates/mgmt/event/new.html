<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <object th:include="fragments/includes_top :: top" th:remove="tag"></object>
    <style>
        .ck-editor__editable_inline {
            min-height: 200px;
            color: black;
        }
    </style>
</head>
<body class="layout-6">
<!-- [ Pre-loader ] start -->
<div class="loader-bg">
    <div class="loader-track">
        <div class="loader-fill"></div>
    </div>
</div>
<!-- [ Pre-loader ] End -->

<object th:include="fragments/navigation_menu :: menu" th:remove="tag"></object>

<object th:include="fragments/header :: head" th:remove="tag"></object>

<!-- [ Main Content ] start -->
<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <!-- [ Main Content ] start -->
                        <div class="row">
                            <!-- [ sample-page ] start -->
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 th:text="eventNews.news"></h5>
                                    </div>
                                    <div class="card-body">
                                        <form th:action="${actionUrl}" method="post" th:object="${eventNews}"
                                              class="justify-content-center">

                                            <div class="ol-md-4 col-sm-4 col-xs-12 mb-3">
                                                <div class="form-group">
                                                    <label for="title" class="control-label">
                                                        <span th:text="#{eventNews_title}"></span>
                                                        <span class="required">*</span>
                                                    </label>
                                                    <input id="title" required="required" th:field="*{title}"
                                                           class="form-control" type="text"/>
                                                </div>
                                            </div>
                                            <div class="ol-md-4 col-sm-4 col-xs-12 mb-3">
                                                <div class="form-group">
                                                    <label for="choice" class="control-label">
                                                        <span th:text="#{eventNews_status}"></span>
                                                        <span class="required">*</span>
                                                    </label>
                                                    <select id="choice" required="required" th:field="*{status}"
                                                            class="form-control" type="text">
                                                        <option value="false" th:text="sys_not_active"></option>
                                                        <option value="true" th:text="sys_active"></option>
                                                        <select>
                                                </div>
                                            </div>
                                            <div class="ol-md-4 col-sm-4 col-xs-12 mb-3">
                                                <div class="form-group">
                                                    <label for="description" class="control-label">
                                                        <span th:text="#{eventNews_description}"></span>
                                                        <span class="required">*</span>
                                                    </label>
                                                    <textarea id="description" required="required"
                                                              th:field="*{description}" class="form-control"
                                                              type="text"/>
                                                </div>
                                            </div>
                                            <div>
                                                <input type="hidden" th:name="${_csrf.parameterName}"
                                                       th:value="${_csrf.token}"/>
                                                <input type="hidden" name="id" th:field="*{id}"/>
                                            </div>
                                            <div>
                                                <button id="submit_form" type="submit" hidden>Submit</button>
                                            </div>
                                        </form>
                                        <h4 class="text-center" th:text="#{sys_about.documentFiles}"></h4>
                                        <div class="col-md-6 offset-md-3 row"
                                             style="padding: 40px 0 40px 0;" id="files-div">
                                            <a href="#upload-file-modal" onclick="openModalFile()"
                                               class="col-md-3" style="padding-bottom: 25px;">
                                                <div class="add-file">
                                                    <img src="/static/images/uploading.gif" alt=""
                                                         id="upload-gif" style="display: none;">
                                                    <span id="percentage"><span
                                                            id="percentage-num"></span>%</span>
                                                    <i class="feather icon-plus" id="plus-icon"></i>
                                                </div>
                                            </a>
                                            <p id="file_error" class="text_error"
                                               th:text="#{sys_about_file_error}"></p>
                                            <div class="col-md-3"
                                                 th:if="${eventNews.fileId != null}"
                                                 id="file-block">
                                                <div class="file">
                                                    <a>
                                                        <i th:if="${file.extension=='doc' || file.extension=='docx'}"
                                                           class="mdi mdi-file-word file-icon"></i>
                                                        <i th:if="${file.extension=='xls' || file.extension=='xlsx'}"
                                                           class="mdi mdi-file-excel file-icon"></i>
                                                        <i th:if="${file.extension=='pdf'}"
                                                           class="mdi mdi-file-pdf file-icon"></i>
                                                        <i th:if="${file.extension=='png' || file.extension=='jpg' || file.extension=='jpeg'}"
                                                           class="mdi mdi-image file-icon"></i>
                                                        <i th:if="${file.extension!='doc'
                                                                                    && file.extension!='docx'
                                                                                    && file.extension!='xls'
                                                                                    && file.extension!='xlsx'
                                                                                    && file.extension!='pdf'
                                                                                    && file.extension!='png'
                                                                                    && file.extension!='jpg'
                                                                                    && file.extension!='jpeg'}"
                                                           class="mdi mdi-file file-icon"></i>
                                                        <span th:text="${file.description}"></span>
                                                        <p th:text="${file.name}"></p>
                                                    </a>
                                                    <button type="button" class="file-delete-btn"
                                                            th:onclick="'deleteFile(' + ${file.id} + ')'">
                                                        <i class="feather icon-x"></i>
                                                    </button>
                                                </div>
                                            </div>

                                        </div>

                                        <div class="col-md-6 text-center">
                                            <a class="btn btn-secondary"
                                               th:href="${T(uz.maroqand.ecology.cabinet.constant.mgmt.MgmtUrls).EventNewsList}"
                                               th:text="#{sys_cancel}"></a>
                                            <input type="submit" th:value="#{sys_add}" class="btn btn-success"
                                                   onclick="submitForm()"/>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <!-- [ sample-page ] end -->
                        </div>
                        <!-- [ Main Content ] end -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- [ Main Content ] end -->
<div class="modal fade" id="upload-file-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="#{sys_about.upload_files}" style="float: left">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="file-name">
                        <span th:text="#{sys_file_name}"></span>
                        <span class="required">*</span>
                    </label>
                    <input class="form-control" type="text" id="file-name" required=""/>
                </div>
                <div class="input-group">
                          <span class="input-group-btn">
                            <span class="btn btn-primary"
                                  style="border-bottom-right-radius: 0px;border-top-right-radius: 0px"
                                  onclick="$(this).parent().find('input[type=file]').click();">
                               <i class="mdi mdi-file-download-outline"></i> <span th:text="#{file_select}"></span>
                            </span>
                            <input name="uploaded_file" required="required" id="file-input"
                                   onchange="$(this).parent().parent().find('.form-control').html($(this).val().split(/[\\|/]/).pop());"
                                   style="display: none;" type="file">
                          </span>
                    <span class="form-control" onclick="$(this).parent().find('input[type=file]').click();"
                          id="fileDescription" style="border-bottom-left-radius: 0px;border-top-left-radius: 0px"
                          placeholder="sdfsdfsdfsdf">

                        </span>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center;">
                <button class="btn btn-info" type="button" th:text="#{sys_upload}" onclick="uploadFile()"></button>
            </div>
        </div>
    </div>
</div>

<object th:include="fragments/includes_bottom :: bottom" th:remove="tag"></object>
<script type="text/javascript" src="/static/js/form.js?v=28122016"></script>
<script src="/static/plugins/ckeditor/js/ckeditor.js"></script>
<script type="text/javascript" src="/static/parsley/parsley.min.js"></script>
<script th:inline="javascript">

    var regApplicationId = [[${eventNews.id}]];
    var eventNewsFileId = [[${eventNews.fileId}]];
    var uploadFileAjaxUrl = [[${T(uz.maroqand.ecology.cabinet.constant.mgmt.MgmtUrls).EventNewsFileUpload}]];
    var deleteFileAjaxUrl = [[${T(uz.maroqand.ecology.cabinet.constant.mgmt.MgmtUrls).EventNewsFileDelete}]];
    let fileError = false;
    let fileSubmit = false;
    let fileCount = 0;


    function openModalFile() {
        console.log($('#files-div').has('#file-block').length)
        if (!$('#files-div').has('#file-block').length) {
            $('#upload-file-modal').modal('show');
            $('#file_error').show();
        }
    }


    function uploadFile() {
        $('#file-name').parsley().validate();
        if (!$('#file-name').val() || !$('#file-input').val()) {
            $('#fileDescription').addClass('is-invalid');

            return;
        }

        $('#upload-file-modal').modal('hide');

        var form = new FormData();
        form.append("id", regApplicationId);
        form.append("file", $('#file-input').prop('files')[0]);
        form.append("file_name", $('#file-name').val());
        form.append("_csrf", $('#global_csrf').val());
        console.log("ajax gacha keldi")
        $.ajax({
            url: uploadFileAjaxUrl,
            type: "POST",
            data: form,
            processData: false,
            contentType: false,
            cache: false,
            success: function (response) {
                console.log(response)
                if (response.status == 1) {

                    $('#files-div').append('<div class="col-md-3" id="file-block' + '">\n' +
                        '                                                    <div class="file">\n' +
                        '                                                        <a href="' + response.link + '">\n' +
                        '                                                            <i class="feather icon-file file-icon"></i>\n' +
                        '                                                            <span>' + response.name + '</span>\n' +
                        '                                                        </a>\n' +
                        '                                                        <button type="button" class="file-delete-btn" onclick="deleteFile(' + response.fileId + ')">\n' +
                        '                                                            <i class="feather icon-x"></i>\n' +
                        '                                                        </button>\n' +
                        '                                                    </div>\n' +
                        '                                                </div>');

                    $('#file_error').hide();
                    fileSubmit = true
                }
            },
            beforeSend: function () {
                $('#plus-icon').hide();
                $('#upload-gif').show();
                $('#percentage').show();
            },
            complete: function () {
                $('#upload-gif').hide();
                $('#percentage').hide();
                $('#plus-icon').show();
            },
            xhr: function () {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress",
                    uploadProgressHandler,
                    false
                );

                return xhr;
            }

        });
    }

    function uploadProgressHandler(event) {
        var percent = (event.loaded / event.total) * 100;
        var progress = Math.round(percent);
        $('#percentage-num').html(progress);
    }


    function submitForm() {
        if (fileSubmit || eventNewsFileId) {
            $('#submit_form').click();
        }
    }

    function deleteFile(fileId) {
        var form = new FormData();
        form.append("id", regApplicationId);
        form.append("fileId", fileId);
        form.append("_csrf", $('#global_csrf').val());

        $.ajax({
            url: deleteFileAjaxUrl,
            type: "POST",
            data: form,
            processData: false,
            contentType: false,
            cache: false,
            success: function (response) {
                if (response.status == 1) {
                    $('#file-block').remove();
                }
            }
        });
    }

    $(document).ready(function () {
        $('#file_error').hide();
    });
</script>
</body>
</html>